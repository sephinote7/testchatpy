# 📑 프로젝트 명세서: Supabase 기반 AI 화상 채팅 요약 시스템

## 1. 프로젝트 개요

PeerJS를 이용한 1:1 화상 채팅 시스템에 Supabase DB를 결합하여, 통화 종료 시 **STT(Speech-to-Text) 데이터**와 **채팅 로그**를 통합 저장하고, Gemini AI를 통해 **대화 내용을 자동 요약**하여 저장하는 시스템입니다.

---

## 2. 기술 스택

- **Frontend**: React, PeerJS, Zustand (상태 관리)
- **Backend/BaaS**: FastAPI (Gemini 연동 API), Supabase (인증 및 DB)
- **AI**: Google Gemini 2.0 Flash (STT 및 요약)

---

## 3. 데이터베이스 설계 (Supabase / PostgreSQL)

### Table: `chat_msg`

| 컬럼명         | 타입      | 제약 조건             | 설명                                      |
| :------------- | :-------- | :-------------------- | :---------------------------------------- |
| **chat_id**    | int8      | Primary Key, Identity | 채팅 레코드 고유 ID                       |
| **cnsl_id**    | int8      | Not Null, FK(bbs)     | 상담 신청 ID (Session 역할)               |
| **member_id**  | varchar   | Not Null, FK(member)  | 일반 사용자 ID                            |
| **cnsler_id**  | varchar   | Not Null, FK(user)    | 상담사 ID                                 |
| **role**       | varchar   |                       | `user`, `system`, `assistant` 구분        |
| **msg_data**   | jsonb     |                       | STT 변환 텍스트 + 채팅 메시지 통합 데이터 |
| **summery**    | text      | Not Null              | Gemini가 요약한 최종 텍스트               |
| **created_at** | timestamp | Default: now()        | 생성 일시                                 |

---

## 4. 핵심 기능 로직

### 1) 사용자 매칭 및 PeerJS 연결

- **ID 전략**: Supabase에서 가져온 `member_id` 또는 `cnsler_id`를 Peer ID로 사용합니다.
- **매칭**: `cnsl_id`(상담 신청 ID)를 기준으로 두 사용자를 1:1 매칭하며, 한 명은 발신자, 한 명은 수신자 역할을 수행합니다.

### 2) 데이터 수집 및 STT

- **채팅 메시지**: PeerJS `DataConnection`을 통해 주고받는 텍스트를 JSON 형태로 `msg_data` 배열에 실시간 누적합니다.
- **음성(STT)**: 통화 중 `MediaRecorder`를 통해 음성 데이터를 캡처하고, 통화 종료 시 FastAPI 서버로 전송하여 STT 변환을 수행합니다.

### 3) 통화 종료 및 요약 자동화 (Workflow)

1. **Event**: 사용자가 `endCall` 버튼 클릭 또는 연결 끊김 감지.
2. **Process 1 (Frontend)**: 녹화된 음성 `Blob`과 채팅 로그를 FastAPI(`/api/summarize`)로 전송.
3. **Process 2 (FastAPI)**:
   - 음성 파일 → Gemini STT 변환.
   - (STT 결과 + 채팅 로그) → Gemini 통합 요약 생성.
4. **Process 3 (Supabase)**: 서버에서 반환된 데이터를 Supabase `chat_msg` 테이블에 `INSERT`.

---

## 5. 단계별 AI 코딩 지시서 (Prompt)

### 1단계: Supabase 연동 및 회원가입

> "Supabase Auth를 사용하여 임시 회원가입 및 로그인 기능을 구현해줘. 사용자 테이블에는 `member_id`(일반 사용자)와 `cnsler_id`(상담사) 구분이 있어야 해."

### 2단계: PeerJS 연결 로직 수정

> "PeerJS 연결 시 난수 대신 Supabase에서 로그인한 사용자의 ID를 사용하도록 수정해줘. 통화 시작 시 `cnsl_id`를 참조하여 특정 상대방과 1:1 연결이 되도록 로직을 작성해줘."

### 3단계: 통화 종료 시 통합 데이터 처리

> "통화 종료(`endCall`) 시 다음 동작을 수행하는 코드를 작성해줘:
>
> 1. `MediaRecorder`로 녹화된 음성 `Blob` 생성.
> 2. Zustand에 저장된 채팅 메시지 리스트 추출.
> 3. 두 데이터를 FastAPI 서버(`/api/summarize`)로 전송.
> 4. 응답 결과를 Supabase `chat_msg` 테이블의 `msg_data`와 `summery` 컬럼에 저장."

---

## 6. 주의 사항 (Troubleshooting)

- **CORS 설정**: FastAPI와 Supabase 설정에서 프론트엔드 도메인을 허용해야 합니다.
- **MIME 타입**: `MediaRecorder`에서 생성된 파일 형식이 서버의 `MIME_MAP`과 일치하는지 확인하세요.
- **에러 처리**: 요약 과정 중 서버 오류가 발생하더라도 최소한 채팅 로그는 저장되도록 예외 처리를 구성하세요.
